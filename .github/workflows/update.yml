# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Update Dependencies

on:
    workflow_dispatch:
        inputs:
            auto-merge:
                description: "Auto-merge PR if checks pass"
                type: boolean
                required: false
                default: true
    schedule:
        # Run every Friday at 4 AM UTC
        - cron: "0 4 * * 5"

run-name: Update npins and flake inputs

permissions:
    contents: write
    pull-requests: write
    checks: read

env:
    GIT_USERNAME: github-actions[bot]
    GIT_EMAIL: github-actions[bot]@users.noreply.github.com

jobs:
    update-dependencies:
        runs-on: ubuntu-latest
        steps:
            - name: Validate Required Secrets
              env:
                  PAT_TOKEN: ${{ secrets.PAT }}
              run: |
                  # Check PAT
                  if [ -z "${PAT_TOKEN}" ]; then
                    echo "::error::PAT secret is not configured"
                    echo "::error::This workflow requires a Personal Access Token (PAT) to:"
                    echo "::error::  1. Create pull requests that trigger CI workflows"
                    echo "::error::  2. Enable auto-merge on pull requests"
                    echo "::error::  3. Access GitHub packages via Nix"
                    echo "::error::"
                    echo "::error::To configure PAT:"
                    echo "::error::  1. Create token at: https://github.com/settings/tokens/new"
                    echo "::error::  2. Required scopes: 'repo', 'workflow'"
                    echo "::error::  3. Add to repository secrets as 'PAT'"
                    echo "::error::  4. Location: https://github.com/${{ github.repository }}/settings/secrets/actions"
                    exit 1
                  fi

                  echo "‚úÖ PAT secret is configured"

            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  token: ${{ secrets.PAT }}

            - name: Install Nix
              uses: cachix/install-nix-action@v31
              with:
                  extra_nix_config: |
                      experimental-features = nix-command flakes
                      accept-flake-config = true
                      access-tokens = github.com=${{ secrets.PAT }}

            - name: Configure Git
              run: |
                  git config --local user.email "${{ env.GIT_EMAIL }}"
                  git config --local user.name "${{ env.GIT_USERNAME }}"

            - name: Capture versions before update
              id: capture-before
              run: |
                  # Capture flake inputs before update
                  echo "Capturing current flake.lock state..."
                  nix flake metadata --json | jq -r '.locks.nodes | with_entries(if .value.locked then .value = .value.locked.rev // .value.locked.narHash // "unknown" else empty end)' > /tmp/before-inputs.json

                  echo "Current inputs:"
                  cat /tmp/before-inputs.json

            - name: Update npins
              id: npins-update
              timeout-minutes: 5
              run: |
                  echo "Updating npins sources..."
                  nix run nixpkgs#npins -- update

                  if ! git diff --quiet npins/sources.json; then
                    echo "updated=true" >> "$GITHUB_OUTPUT"
                  else
                    echo "updated=false" >> "$GITHUB_OUTPUT"
                  fi

            - name: Update neovim plugin npins (start)
              id: npins-neovim-start
              timeout-minutes: 5
              run: |
                  echo "Updating neovim start plugins..."
                  cd packages/neovim

                  nix run .#npins -- --lock-file ./start.json update -f 2>&1 | { grep '.*Changes:$\|.*url:.*' || true; }

                  cd ../..

                  if ! git diff --quiet packages/neovim/start.json; then
                    echo "updated=true" >> "$GITHUB_OUTPUT"
                  else
                    echo "updated=false" >> "$GITHUB_OUTPUT"
                  fi

            - name: Update neovim plugin npins (opt)
              id: npins-neovim-opt
              timeout-minutes: 5
              run: |
                  echo "Updating neovim opt plugins..."
                  cd packages/neovim

                  nix run .#npins -- --lock-file ./opt.json update -f 2>&1 | { grep '.*Changes:$\|.*url:.*' || true; }

                  cd ../..

                  if ! git diff --quiet packages/neovim/opt.json; then
                    echo "updated=true" >> "$GITHUB_OUTPUT"
                  else
                    echo "updated=false" >> "$GITHUB_OUTPUT"
                  fi

            - name: Update flake.lock
              id: flake-update
              timeout-minutes: 10
              run: |
                  echo "Starting flake update (excluding private inputs)..."

                  # Update only public inputs, skip private ones
                  # List all inputs except the private ones
                  INPUTS_TO_UPDATE=$(nix flake metadata --json | jq -r '
                    .locks.nodes.root.inputs |
                    to_entries[] |
                    select(.key != "monolisa-font-flake" and .key != "wallpapers" and .key != "beancount-repo") |
                    .key
                  ' | tr '\n' ' ')

                  echo "Updating inputs: $INPUTS_TO_UPDATE"

                  for input in $INPUTS_TO_UPDATE; do
                    echo "Updating $input..."
                    nix flake lock --update-input "$input" 2>&1 | tee -a /tmp/flake-update.log || true
                  done

                  echo "Flake update completed"

                  if ! git diff --quiet flake.lock; then
                    echo "updated=true" >> "$GITHUB_OUTPUT"
                  else
                    echo "updated=false" >> "$GITHUB_OUTPUT"
                  fi

            - name: Upload flake update log on failure
              if: failure()
              uses: actions/upload-artifact@v6
              with:
                  name: flake-update-log
                  path: /tmp/flake-update.log
                  if-no-files-found: ignore

            - name: Build commit message and commit changes
              id: commit-changes
              run: |
                  # Check if there are any changes
                  if git diff --quiet && git diff --cached --quiet; then
                    echo "No updates to commit"
                    echo "has_changes=false" >> "$GITHUB_OUTPUT"
                    exit 0
                  fi

                  echo "has_changes=true" >> "$GITHUB_OUTPUT"

                  # Determine what was updated
                  HAS_NPINS=false
                  HAS_NEOVIM_START=false
                  HAS_NEOVIM_OPT=false
                  HAS_FLAKE=false

                  if ! git diff --quiet npins/sources.json; then
                    HAS_NPINS=true
                  fi

                  if ! git diff --quiet packages/neovim/start.json; then
                    HAS_NEOVIM_START=true
                  fi

                  if ! git diff --quiet packages/neovim/opt.json; then
                    HAS_NEOVIM_OPT=true
                  fi

                  if ! git diff --quiet flake.lock; then
                    HAS_FLAKE=true
                  fi

                  # Start building commit message
                  COMMIT_MSG="chore: update dependencies"

                  COMMIT_BODY=""

                  # Add npins changes if present
                  if [ "$HAS_NPINS" = true ]; then
                    COMMIT_BODY="${COMMIT_BODY}Updated npins sources\n\n"
                    git add npins/sources.json
                  fi

                  # Add neovim plugin changes if present
                  if [ "$HAS_NEOVIM_START" = true ] || [ "$HAS_NEOVIM_OPT" = true ]; then
                    COMMIT_BODY="${COMMIT_BODY}Updated neovim plugins:\n"
                    if [ "$HAS_NEOVIM_START" = true ]; then
                      COMMIT_BODY="${COMMIT_BODY}  - start plugins\n"
                      git add packages/neovim/start.json
                    fi
                    if [ "$HAS_NEOVIM_OPT" = true ]; then
                      COMMIT_BODY="${COMMIT_BODY}  - opt plugins\n"
                      git add packages/neovim/opt.json
                    fi
                    COMMIT_BODY="${COMMIT_BODY}\n"
                  fi

                  # Add flake changes if present
                  if [ "$HAS_FLAKE" = true ]; then
                    # Capture after state
                    nix flake metadata --json | jq -r '.locks.nodes | with_entries(if .value.locked then .value = .value.locked.rev // .value.locked.narHash // "unknown" else empty end)' > /tmp/after-inputs.json

                    # Generate version changes
                    COMMIT_BODY="${COMMIT_BODY}Updated flake inputs:\n\n"

                    # Compare before and after
                    jq -r 'keys[]' /tmp/before-inputs.json | while read -r input; do
                      BEFORE_REV=$(jq -r --arg key "$input" 'if .[$key] then .[$key] else "missing" end' /tmp/before-inputs.json)
                      AFTER_REV=$(jq -r --arg key "$input" 'if .[$key] then .[$key] else "missing" end' /tmp/after-inputs.json)

                      if [ "$BEFORE_REV" != "$AFTER_REV" ] && [ "$BEFORE_REV" != "missing" ] && [ "$AFTER_REV" != "missing" ]; then
                        # Truncate revisions for readability
                        BEFORE_SHORT="${BEFORE_REV:0:8}"
                        AFTER_SHORT="${AFTER_REV:0:8}"
                        COMMIT_BODY="${COMMIT_BODY}  ${input}: ${BEFORE_SHORT} -> ${AFTER_SHORT}\n"
                      fi
                    done

                    git add flake.lock
                  fi

                  # Build full commit message
                  {
                    echo "${COMMIT_MSG}"
                    echo ""
                    echo -e "${COMMIT_BODY}"
                  } > /tmp/commit-msg.txt

                  git commit -F /tmp/commit-msg.txt

                  echo "Commit created successfully"

            - name: Create summary
              if: steps.commit-changes.outputs.has_changes == 'true'
              run: |
                  {
                    echo "## Update Summary"
                    echo ""
                    if [ "${{ steps.npins-update.outputs.updated }}" = "true" ]; then
                      echo "‚úÖ npins sources updated"
                    fi
                    if [ "${{ steps.npins-neovim-start.outputs.updated }}" = "true" ]; then
                      echo "‚úÖ Neovim start plugins updated"
                    fi
                    if [ "${{ steps.npins-neovim-opt.outputs.updated }}" = "true" ]; then
                      echo "‚úÖ Neovim opt plugins updated"
                    fi
                    if [ "${{ steps.flake-update.outputs.updated }}" = "true" ]; then
                      echo "‚úÖ Flake inputs updated"
                    fi
                    echo ""
                    echo "### Changes"
                    echo '```'
                    git log -1 --pretty=format:"%B"
                    echo '```'
                  } >> "$GITHUB_STEP_SUMMARY"

            - name: Create Pull Request
              if: steps.commit-changes.outputs.has_changes == 'true'
              id: create-pr
              uses: peter-evans/create-pull-request@v8
              with:
                  token: ${{ secrets.PAT }}
                  branch: automated-flake-update
                  delete-branch: true
                  title: "chore: update dependencies"
                  body: |
                      ## Automated Dependency Update

                      This PR contains automated updates for dependencies.

                      ### Updated
                      ${{ steps.npins-update.outputs.updated == 'true' && '- ‚úÖ npins sources' || '' }}
                      ${{ steps.npins-neovim-start.outputs.updated == 'true' && '- ‚úÖ Neovim start plugins' || '' }}
                      ${{ steps.npins-neovim-opt.outputs.updated == 'true' && '- ‚úÖ Neovim opt plugins' || '' }}
                      ${{ steps.flake-update.outputs.updated == 'true' && '- ‚úÖ Flake inputs' || '' }}

                      ### Commit Details
                      See the commit message for a detailed list of all version changes.

                      **Triggered by:** ${{ github.event_name == 'workflow_dispatch' && 'Manual trigger' || 'Scheduled run' }}

                      ---

                      ü§ñ This PR was automatically created by the update workflow.
                      ${{ (github.event_name == 'schedule' || inputs.auto-merge) && 'üîÑ Will auto-merge when checks pass.' || '' }}
                  labels: |
                      dependencies
                      automated
                  draft: false

            - name: Enable auto-merge
              if: |
                  steps.create-pr.outputs.pull-request-number &&
                  (github.event_name == 'schedule' || inputs.auto-merge)
              env:
                  GH_TOKEN: ${{ secrets.PAT }}
                  PR_NUMBER: ${{ steps.create-pr.outputs.pull-request-number }}
              run: |
                  echo "Enabling auto-merge for PR #${PR_NUMBER}"
                  echo ""
                  echo "‚ÑπÔ∏è  Auto-merge will wait for the following before merging:"
                  echo "  - Required status checks configured in branch protection"
                  echo ""
                  gh pr merge "${PR_NUMBER}" --auto --squash --delete-branch
